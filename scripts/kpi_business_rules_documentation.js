#!/usr/bin/env node

/**
 * üìä DOCUMENTA√á√ÉO COMPLETA DAS REGRAS DE NEG√ìCIO DOS KPIs
 * =====================================================
 *
 * Este arquivo documenta EXATAMENTE como cada KPI est√° sendo calculado
 * no sistema atual para identificar diverg√™ncias com o controle manual.
 */

const https = require('https');

const SUPABASE_URL = process.env.SUPABASE_URL;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  console.error('‚ùå Missing required environment variables');
  process.exit(1);
}

const supabaseHeaders = {
  apikey: SUPABASE_SERVICE_ROLE_KEY,
  Authorization: `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
  'Content-Type': 'application/json',
};

function makeRequest(url, options = {}) {
  return new Promise((resolve, reject) => {
    const req = https.request(url, options, (res) => {
      let data = '';
      res.on('data', (chunk) => (data += chunk));
      res.on('end', () => {
        if (res.statusCode >= 200 && res.statusCode < 300) {
          try {
            resolve(JSON.parse(data));
          } catch (e) {
            resolve(data);
          }
        } else {
          reject(new Error(`HTTP ${res.statusCode}: ${data}`));
        }
      });
    });

    req.on('error', reject);
    req.end();
  });
}

async function documentKPIRules() {
  console.log('üìä DOCUMENTA√á√ÉO COMPLETA DOS KPIs');
  console.log('=================================');
  console.log('');

  // 1. MRR (Monthly Recurring Revenue)
  console.log('üí∞ 1. MRR (MONTHLY RECURRING REVENUE)');
  console.log('=====================================');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ Campo usado: paid_cents (valor efetivamente pago)');
  console.log('‚Ä¢ Crit√©rio temporal: paid_at (data do pagamento)');
  console.log('‚Ä¢ Filtros: status = "paid"');
  console.log('‚Ä¢ Filtros: subscription_id IS NOT NULL (s√≥ faturas com assinatura)');
  console.log('‚Ä¢ Exclus√µes: devolu√ß√µes (status = "refunded")');
  console.log('‚Ä¢ Per√≠odo: m√™s espec√≠fico baseado em paid_at');
  console.log('');
  console.log('SQL EQUIVALENTE:');
  console.log(`SELECT SUM(paid_cents)/100 as mrr
FROM iugu_invoices 
WHERE status = 'paid' 
  AND subscription_id IS NOT NULL
  AND paid_at >= '2025-08-01' 
  AND paid_at < '2025-09-01'`);
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Usa paid_cents vs total_cents?');
  console.log('‚Ä¢ Inclui devolu√ß√µes ou n√£o?');
  console.log('‚Ä¢ Considera subscription_id ou todos os pagamentos recorrentes?');
  console.log('‚Ä¢ Data de pagamento vs data de vencimento vs data de cria√ß√£o?');
  console.log('');

  // 2. Receita Bruta
  console.log('üíµ 2. RECEITA BRUTA');
  console.log('==================');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ Campo usado: paid_cents (valor efetivamente pago)');
  console.log('‚Ä¢ Crit√©rio temporal: paid_at (data do pagamento)');
  console.log('‚Ä¢ Filtros: status = "paid"');
  console.log('‚Ä¢ Inclui: TODAS as faturas pagas (com ou sem assinatura)');
  console.log('‚Ä¢ Exclus√µes: devolu√ß√µes s√£o calculadas separadamente');
  console.log('');
  console.log('SQL EQUIVALENTE:');
  console.log(`SELECT SUM(paid_cents)/100 as receita_bruta
FROM iugu_invoices 
WHERE status = 'paid' 
  AND paid_at >= '2025-08-01' 
  AND paid_at < '2025-09-01'`);
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Valor bruto vs l√≠quido (antes/depois de taxas)?');
  console.log('‚Ä¢ Inclui taxas da Iugu ou valor que chega na conta?');
  console.log('‚Ä¢ paid_cents vs total_cents vs valor recebido?');
  console.log('');

  // 3. Devolu√ß√µes
  console.log('üîÑ 3. DEVOLU√á√ïES');
  console.log('===============');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ Campo usado: total_cents (valor total da fatura devolvida)');
  console.log('‚Ä¢ Crit√©rio temporal: created_at_iugu (data de cria√ß√£o da devolu√ß√£o)');
  console.log('‚Ä¢ Filtros: status = "refunded"');
  console.log('‚Ä¢ Valor: negativo (multiplicado por -1)');
  console.log('');
  console.log('SQL EQUIVALENTE:');
  console.log(`SELECT -SUM(total_cents)/100 as devolucoes
FROM iugu_invoices 
WHERE status = 'refunded' 
  AND created_at_iugu >= '2025-08-01' 
  AND created_at_iugu < '2025-09-01'`);
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Data de cria√ß√£o vs data de processamento da devolu√ß√£o?');
  console.log('‚Ä¢ total_cents vs paid_cents vs valor efetivamente devolvido?');
  console.log('‚Ä¢ Inclui devolu√ß√µes parciais?');
  console.log('');

  // 4. Receita L√≠quida
  console.log('üíé 4. RECEITA L√çQUIDA');
  console.log('====================');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ C√°lculo: Receita Bruta + Devolu√ß√µes');
  console.log('‚Ä¢ Devolu√ß√µes s√£o negativas, ent√£o √© uma subtra√ß√£o');
  console.log('‚Ä¢ N√£o considera taxas/comiss√µes da Iugu');
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Receita l√≠quida = bruta - devolu√ß√µes - taxas Iugu?');
  console.log('‚Ä¢ Ou receita l√≠quida = valor que efetivamente chega na conta?');
  console.log('‚Ä¢ Considera comiss√µes/taxas de processamento?');
  console.log('');

  // 5. M√©todos de Pagamento
  console.log('üí≥ 5. M√âTODOS DE PAGAMENTO (PIX, CART√ÉO, BOLETO)');
  console.log('===============================================');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ Campo usado: payment_method');
  console.log('‚Ä¢ Valores: "iugu_pix", "iugu_credit_card", "iugu_bank_slip"');
  console.log('‚Ä¢ Campo valor: paid_cents');
  console.log('‚Ä¢ Crit√©rio temporal: paid_at');
  console.log('‚Ä¢ Filtros: status = "paid"');
  console.log('');
  console.log('SQL EQUIVALENTE:');
  console.log(`SELECT 
  payment_method,
  SUM(paid_cents)/100 as valor
FROM iugu_invoices 
WHERE status = 'paid' 
  AND paid_at >= '2025-06-01' 
  AND paid_at < '2025-07-01'
GROUP BY payment_method`);
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Faturas com payment_method NULL s√£o inclu√≠das onde?');
  console.log('‚Ä¢ Outros m√©todos (d√©bito, transfer√™ncia) s√£o considerados?');
  console.log('‚Ä¢ paid_cents vs valor l√≠quido ap√≥s taxas do m√©todo?');
  console.log('');

  // 6. Faturas Geradas
  console.log('üìÑ 6. FATURAS GERADAS');
  console.log('====================');
  console.log('REGRA ATUAL NO SISTEMA:');
  console.log('‚Ä¢ Contagem: COUNT(*) de faturas');
  console.log('‚Ä¢ Crit√©rio temporal: created_at_iugu (data de cria√ß√£o)');
  console.log('‚Ä¢ Filtros: NENHUM (todas as faturas criadas)');
  console.log('‚Ä¢ Inclui: pagas, pendentes, canceladas, expiradas');
  console.log('');
  console.log('SQL EQUIVALENTE:');
  console.log(`SELECT COUNT(*) as faturas_geradas
FROM iugu_invoices 
WHERE created_at_iugu >= '2025-08-01' 
  AND created_at_iugu < '2025-09-01'`);
  console.log('');
  console.log('‚ùì POSS√çVEIS DIVERG√äNCIAS:');
  console.log('‚Ä¢ Conta todas as faturas ou s√≥ as v√°lidas?');
  console.log('‚Ä¢ Exclui faturas de teste?');
  console.log('‚Ä¢ Considera apenas faturas enviadas ao cliente?');
  console.log('');

  console.log('');
  console.log('üîç VERIFICA√á√ÉO PR√ÅTICA');
  console.log('=====================');

  try {
    // Exemplo pr√°tico para Agosto 2025
    console.log('üìÖ EXEMPLO: AGOSTO 2025');
    console.log('');

    // MRR
    const mrrInvoices = await makeRequest(
      `${SUPABASE_URL}/rest/v1/iugu_invoices?select=id,paid_cents,subscription_id&status=eq.paid&subscription_id=not.is.null&paid_at=gte.2025-08-01&paid_at=lt.2025-09-01&limit=5`,
      { headers: supabaseHeaders }
    );
    console.log('üìä AMOSTRA MRR (5 faturas):');
    if (mrrInvoices && mrrInvoices.length > 0) {
      mrrInvoices.forEach((inv, i) => {
        console.log(
          `   ${i + 1}. ${inv.id}: R$ ${(inv.paid_cents / 100).toFixed(2)} (subscription: ${inv.subscription_id})`
        );
      });
    }
    console.log('');

    // M√©todos de pagamento √∫nicos
    const paymentMethods = await makeRequest(
      `${SUPABASE_URL}/rest/v1/iugu_invoices?select=payment_method&status=eq.paid&paid_at=gte.2025-08-01&paid_at=lt.2025-09-01&limit=1000`,
      { headers: supabaseHeaders }
    );
    if (paymentMethods) {
      const methods = [...new Set(paymentMethods.map((p) => p.payment_method))];
      console.log('üí≥ M√âTODOS DE PAGAMENTO ENCONTRADOS:');
      methods.forEach((method) => {
        console.log(`   ‚Ä¢ ${method || 'NULL'}`);
      });
    }
    console.log('');

    // Status das faturas
    const statuses = await makeRequest(
      `${SUPABASE_URL}/rest/v1/iugu_invoices?select=status&created_at_iugu=gte.2025-08-01&created_at_iugu=lt.2025-09-01&limit=1000`,
      { headers: supabaseHeaders }
    );
    if (statuses) {
      const statusCounts = statuses.reduce((acc, s) => {
        acc[s.status || 'NULL'] = (acc[s.status || 'NULL'] || 0) + 1;
        return acc;
      }, {});
      console.log('üìä STATUS DAS FATURAS (AGOSTO):');
      Object.entries(statusCounts).forEach(([status, count]) => {
        console.log(`   ‚Ä¢ ${status}: ${count} faturas`);
      });
    }
  } catch (err) {
    console.error(`‚ùå Erro na verifica√ß√£o: ${err.message}`);
  }

  console.log('');
  console.log('üìã PR√ìXIMOS PASSOS:');
  console.log('==================');
  console.log('1. Revisar cada regra acima com seus crit√©rios manuais');
  console.log('2. Identificar diverg√™ncias espec√≠ficas');
  console.log('3. Ajustar os c√°lculos conforme necess√°rio');
  console.log('4. Recalcular os KPIs com as regras corretas');
  console.log('5. Validar contra os n√∫meros reais');
  console.log('');
  console.log('‚ùì QUEST√ïES ESPEC√çFICAS PARA VOC√ä:');
  console.log('================================');
  console.log('A. MRR deve usar paid_cents ou total_cents?');
  console.log('B. Receita bruta inclui taxas da Iugu ou √© valor l√≠quido?');
  console.log('C. Devolu√ß√µes: data de cria√ß√£o ou data de processamento?');
  console.log('D. M√©todos de pagamento: h√° outros al√©m de PIX/Cart√£o/Boleto?');
  console.log('E. Faturas geradas: inclui todas ou s√≥ as enviadas?');
  console.log('F. H√° exclus√µes espec√≠ficas (teste, cancelamentos, etc.)?');
}

// Executar se chamado diretamente
if (require.main === module) {
  documentKPIRules()
    .then(() => {
      console.log('');
      console.log('‚úÖ Documenta√ß√£o conclu√≠da!');
      process.exit(0);
    })
    .catch((err) => {
      console.error(`üí• Erro: ${err.message}`);
      process.exit(1);
    });
}

module.exports = { documentKPIRules };
